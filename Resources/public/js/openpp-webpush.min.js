(function(k){function g(a){var c={swPath:"/serviceworker.js",swScope:"./",keyPath:"/api/key/publicKey",registerPath:"/api/device/web/register",unregisterPath:"/api/device/web/unregister",getRegistrationPath:"/api/device/registration",applicationId:(new URL(location.href)).origin};a=a||{};for(var f in c)"undefined"===typeof a[f]&&(a[f]=c[f]);this.swPath=a.swPath;this.swScope=a.swScope;this.keyPath=a.keyPath;this.registerPath=a.registerPath;this.unregisterPath=a.unregisterPath;this.getRegistrationPath=
a.getRegistrationPath;this.applicationId=a.applicationId;this._registration=this._subscription=this._serverPublicKey=null;this._state="unknown";this._listeners=null;b=this}var b=null;g.Event=function(b){this.type=b};var d=g.prototype;d.addEventListener=function(b,c){var a=this._listeners=this._listeners||{},e=a[b];e&&this.removeEventListener(b,c);(e=a[b])?e.push(c):a[b]=[c];return c};d.removeEventListener=function(b,c){var a=this._listeners;if(a){var e=a[b];if(e)for(var d=0,h=e.length;d<h;d++)if(e[d]==
c){1==h?delete a[b]:e.splice(d,1);break}}};d.dispatchEvent=function(a){if("string"==typeof a){var c=b._listeners;if(!c||!c[a])return!0;a=new g.Event(a)}c=b._listeners;if(a&&c&&(c=c[a.type])&&c.length)for(var c=c.slice(),f=0;f<c.length;f++){var e=c[f];e.handleEvent?e.handleEvent(a):e(a)}};d._triggerUnsupportedEvent=function(a){b._state="unsupported";var c=new g.Event("unsupported");c.message=a;b.dispatchEvent(c)};d._triggerErrorEvent=function(a){b._state="error";var c=new g.Event("error");c.message=
a;b.dispatchEvent(c)};d._triggerStateChangeEvent=function(a){b._state=a;var c=new g.Event("statechange");c.state=a;c.data=b._registration;b.dispatchEvent(c)};d.initialize=function(){b.isServiceWorkerSupported()?navigator.serviceWorker.register(b.swPath,{scope:b.swScope}).then(b._checkSubscription)["catch"](function(a){console.log("Failed to register the service worker."+a);b._triggerErrorEvent("Failed to register the service worker.")}):(console.log('Unsupported property "serviceWorker" in navigator.'),
b._triggerUnsupportedEvent('Unsupported property "serviceWorker" in navigator.'))};d.isServiceWorkerSupported=function(){return"serviceWorker"in navigator?!0:!1};d.getStatus=function(){return b._state};d.getUid=function(){return b._registration?b._registration.uid:null};d.setApplicationId=function(b){this.applicationId=b};d.togglePushRequest=function(a){a?b._requestPermission():b._unsubscribe()};d._requestPermission=function(){Notification.requestPermission(function(a){"denied"!==a&&b._subscribe()})};
d._checkSubscription=function(a){"pushManager"in a?b._fetchServerPublicKey().then(function(c){a.pushManager.getSubscription().then(function(a){a?(b._subscription=a,b._registration?b._triggerStateChangeEvent("subscribing"):b._fetchRegistration(a).then(function(a){b._triggerStateChangeEvent("subscribing")})["catch"](function(c){b._register(a).then(function(a){b._triggerStateChangeEvent("subscribing")})})):b._triggerStateChangeEvent("unsubscribing")})["catch"](function(a){b._triggerErrorEvent(a)})})["catch"](function(a){b._triggerErrorEvent(a)}):
(console.log('Unsupported property "pushManager" in ServiceWorkerRegistration.'),b._triggerUnsupportedEvent('Unsupported property "pushManager" in ServiceWorkerRegistration.'))};d._subscribe=function(){navigator.serviceWorker.getRegistration().then(function(a){a?a.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:b._serverPublicKey}).then(function(a){b._subscription=a;b._register(a).then(function(a){b._triggerStateChangeEvent("subscribing")})})["catch"](function(a){console.log("Failed to subscribe."+
a);b._triggerErrorEvent("Failed to subscribe.")}):b._triggerErrorEvent("ServiceWorker is not registered.")})};d._unsubscribe=function(){b._subscription&&b._unregister(b._subscription).then(function(a){b._subscription.unsubscribe().then(function(a){b._subscription=null;b._triggerStateChangeEvent("unsubscribing")})["catch"](function(a){console.log("Failed to unsubscribe."+a);b._triggerErrorEvent("Failed to unsubscribe.")})})};d._encodeBase64URL=function(a){return btoa(String.fromCharCode.apply(null,
new Uint8Array(a))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")};d._decodeBase64URL=function(a){a=atob(a.replace(/\-/g,"+").replace(/_/g,"/"));for(var b=new Uint8Array(a.length),f=0;f<a.length;f++)b[f]=a.charCodeAt(f);return b};d._fetchServerPublicKey=function(){return new Promise(function(a,c){fetch(b.keyPath,{headers:{"X-APPLICATION":b.applicationId}}).then(function(b){return b.text()}).then(function(d){try{b._serverPublicKey=b._decodeBase64URL(d),a(b._serverPublicKey)}catch(e){console.log("Failed to fetch the server public key."+
e),c("Failed to fetch the server public key.")}})["catch"](function(b){console.log("Failed to fetch the server public key."+b);c("Failed to fetch the server public key.")})})};d._register=function(a){return new Promise(function(c,d){if("getKey"in a){var e=b._encodeBase64URL(a.getKey("p256dh"));try{var f=b._encodeBase64URL(a.getKey("auth"))}catch(h){console.log("Failed to get authorization token."+h);b._triggerUnsupportedEvent("Failed to get authorization token.");d("Failed to get authorization token.");
return}fetch(b.registerPath,{method:"POST",body:JSON.stringify({application_id:b.applicationId,endpoint:a.endpoint,key:e,auth:f}),headers:{"Content-Type":"application/json","X-APPLICATION":b.applicationId}}).then(function(b){return b.json()}).then(function(a){"code"in a?(console.log("Faild to register to the server."+a.message),b._triggerErrorEvent("Faild to register to the server."),d("Faild to register to the server.")):(b._registration=a,c(a))})["catch"](function(a){console.log("Faild to register to the server."+
a);b._triggerErrorEvent("Faild to register to the server.");d("Faild to register to the server.")})}else console.log('Undefined function "getKey" in PushSubscription.'),b._triggerUnsupportedEvent('Undefined function "getKey" in PushSubscription.'),d('Undefined function "getKey" in PushSubscription.')})};d._unregister=function(a){return new Promise(function(c,d){fetch(b.unregisterPath,{method:"POST",body:JSON.stringify({application_id:b.applicationId,endpoint:a.endpoint}),headers:{"Content-Type":"application/json",
"X-APPLICATION":b.applicationId}}).then(function(a){return a.json()}).then(function(a){"code"in a?(console.log("Faild to unregister from the server."+a.message),b._triggerErrorEvent("Faild to unregister from the server."),d("Faild to unregister from the server.")):(b._registration=null,c(a))})["catch"](function(a){console.log("Faild to unregister from the server."+a);b._triggerErrorEvent("Faild to unregister from the server.");d("Faild to unregister from the server.")})})};d._fetchRegistration=function(a){return new Promise(function(c,
d){var e={application_id:b.applicationId,device_identifier:a.endpoint},f=new URLSearchParams;Object.keys(e).forEach(function(a){return f.set(a,e[a])});fetch(b.getRegistrationPath+"?"+f.toString(),{headers:{"Content-Type":"application/json","X-APPLICATION":b.applicationId}}).then(function(a){return a.json()}).then(function(a){"code"in a?(console.log(a.message),d(a.message)):(b._registration=a,c(a))})["catch"](function(a){console.log("Faild to fetch registration from the server."+a);b._triggerErrorEvent("Faild to fetch registration from the server.");
d("Faild to fetch registration from the server.")})})};k.OpenppWebPush=g})(window);